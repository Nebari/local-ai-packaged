<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KeikenV Status Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            color: #333;
        }

        .header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            padding: 2rem 0;
            text-align: center;
            color: white;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header h1 {
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 3rem;
        }

        .overview-card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 2rem;
            text-align: center;
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .overview-card .number {
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .overview-card .label {
            font-size: 1rem;
            opacity: 0.9;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-healthy {
            background-color: #10b981;
        }

        .status-degraded {
            background-color: #f59e0b;
        }

        .status-unhealthy {
            background-color: #ef4444;
        }

        .status-unknown {
            background-color: #6b7280;
        }

        .category {
            background: white;
            border-radius: 20px;
            margin-bottom: 2rem;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .category-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem 2rem;
            font-size: 1.3rem;
            font-weight: 600;
        }

        .services-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 0;
        }

        .service-card {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid #f0f0f0;
            border-right: 1px solid #f0f0f0;
            transition: all 0.3s ease;
        }

        .service-card:hover {
            background: #f8f9fa;
            transform: translateY(-2px);
        }

        .service-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .service-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
        }

        .service-description {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .service-metrics {
            display: flex;
            gap: 1rem;
            font-size: 0.8rem;
            color: #888;
        }

        .metric {
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .status-badge {
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-healthy {
            background: #ecfdf5;
            color: #065f46;
        }

        .badge-unhealthy {
            background: #fef2f2;
            color: #991b1b;
        }

        .badge-unknown {
            background: #f3f4f6;
            color: #374151;
        }

        .external-link {
            color: #667eea;
            text-decoration: none;
            font-size: 0.9rem;
            margin-top: 0.5rem;
            display: inline-block;
        }

        .external-link:hover {
            text-decoration: underline;
        }

        .loading {
            text-align: center;
            padding: 3rem;
            color: white;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .last-updated {
            text-align: center;
            color: rgba(255, 255, 255, 0.8);
            margin-top: 2rem;
            font-size: 0.9rem;
        }

        .management-controls {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .management-title {
            color: white;
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .control-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .control-btn {
            padding: 0.8rem 2rem;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 120px;
        }

        .btn-start {
            background: #10b981;
            color: white;
        }

        .btn-start:hover {
            background: #059669;
            transform: translateY(-2px);
        }

        .btn-stop {
            background: #ef4444;
            color: white;
        }

        .btn-stop:hover {
            background: #dc2626;
            transform: translateY(-2px);
        }

        .btn-restart {
            background: #f59e0b;
            color: white;
        }

        .btn-restart:hover {
            background: #d97706;
            transform: translateY(-2px);
        }

        .btn-disabled {
            background: #6b7280;
            cursor: not-allowed;
            transform: none !important;
        }

        .operation-status {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 1rem;
            margin-top: 1rem;
            color: white;
            display: none;
        }

        .operation-success {
            background: rgba(16, 185, 129, 0.2);
            border-left: 4px solid #10b981;
        }

        .operation-error {
            background: rgba(239, 68, 68, 0.2);
            border-left: 4px solid #ef4444;
        }

        .service-controls {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .service-btn {
            padding: 0.3rem 0.8rem;
            border: none;
            border-radius: 5px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .service-btn:hover {
            transform: translateY(-1px);
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(255, 255, 255, 0.90) 100%);
            margin: 5% auto;
            padding: 2rem;
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(20px);
            position: relative;
        }

        .close {
            color: #666;
            float: right;
            font-size: 2rem;
            font-weight: bold;
            position: absolute;
            top: 1rem;
            right: 1.5rem;
            cursor: pointer;
        }

        .close:hover {
            color: #333;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.8rem;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            font-size: 1rem;
            background: rgba(255, 255, 255, 0.8);
            box-sizing: border-box;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #10b981;
            background: rgba(255, 255, 255, 0.95);
        }

        .server-config-section {
            background: rgba(255, 255, 255, 0.4);
            padding: 1.5rem;
            border-radius: 10px;
            margin: 1rem 0;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .server-config-section h3 {
            margin-top: 0;
            margin-bottom: 1rem;
            color: #333;
        }

        #mcpServersList {
            max-height: 400px;
            overflow-y: auto;
        }

        .server-item {
            background: rgba(255, 255, 255, 0.6);
            padding: 1rem;
            margin: 0.5rem 0;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .server-info h4 {
            margin: 0 0 0.5rem 0;
            color: #333;
        }

        .server-info p {
            margin: 0;
            color: #666;
            font-size: 0.9rem;
        }

        .server-actions button {
            padding: 0.4rem 1rem;
            margin-left: 0.5rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        #mcpConfigContent {
            background: rgba(0, 0, 0, 0.8);
            color: #00ff00;
            padding: 1.5rem;
            border-radius: 10px;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            white-space: pre-wrap;
        }

        .error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #dc2626;
            padding: 1rem;
            border-radius: 10px;
            margin: 1rem 0;
            text-align: center;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }

            .services-grid {
                grid-template-columns: 1fr;
            }

            .container {
                padding: 1rem;
            }
        }
    </style>
</head>

<body>
    <div class="header">
        <h1>🚀 KeikenV</h1>
        <p>Autonomous AI Agent Platform - Service Status</p>
    </div>

    <div class="container">
        <div class="management-controls">
            <div class="management-title">Service Management</div>
            <div class="control-buttons">
                <button class="control-btn btn-start" onclick="performBulkAction('start')">
                    Start All Services
                </button>
                <button class="control-btn btn-stop" onclick="performBulkAction('stop')">
                    Stop All Services
                </button>
                <button class="control-btn btn-restart" onclick="performBulkAction('restart')">
                    Restart All Services
                </button>
            </div>
            <div id="operationStatus" class="operation-status"></div>
        </div>

        <div class="management-controls">
            <div class="management-title">🔧 MCP Server Management</div>
            <div class="control-buttons">
                <button class="control-btn btn-start" onclick="showMcpServerForm()">
                    ➕ Add MCP Server
                </button>
                <button class="control-btn btn-restart" onclick="loadMcpServers()">
                    📋 View Servers
                </button>
                <button class="control-btn btn-stop" onclick="showMcpConfig()">
                    ⚙️ View Config
                </button>
            </div>
            <div id="mcpOperationStatus" class="operation-status"></div>
        </div>

        <!-- MCP Server Form Modal -->
        <div id="mcpServerModal" class="modal" style="display: none;">
            <div class="modal-content">
                <span class="close" onclick="closeMcpServerForm()">&times;</span>
                <h2>Add New MCP Server</h2>

                <div class="form-group">
                    <label for="serverTemplate">Server Type:</label>
                    <select id="serverTemplate" onchange="loadServerTemplate()">
                        <option value="">Select a template...</option>
                        <option value="stdio">Standard I/O Server</option>
                        <option value="http">HTTP Server</option>
                        <option value="sse">Server-Sent Events</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="serverName">Server Name:</label>
                    <input type="text" id="serverName" placeholder="my-new-server" pattern="[a-zA-Z0-9_-]+"
                        title="Only letters, numbers, hyphens, and underscores allowed">
                </div>

                <div class="form-group">
                    <label for="serverDescription">Description:</label>
                    <input type="text" id="serverDescription" placeholder="Brief description of the server">
                </div>

                <div id="stdio-config" class="server-config-section" style="display: none;">
                    <h3>Standard I/O Configuration</h3>
                    <div class="form-group">
                        <label for="stdioCommand">Command:</label>
                        <input type="text" id="stdioCommand" placeholder="npx" value="npx">
                    </div>
                    <div class="form-group">
                        <label for="stdioArgs">Arguments (one per line):</label>
                        <textarea id="stdioArgs" rows="3"
                            placeholder="-y&#10;@modelcontextprotocol/server-example"></textarea>
                    </div>
                </div>

                <div id="http-config" class="server-config-section" style="display: none;">
                    <h3>HTTP Server Configuration</h3>
                    <div class="form-group">
                        <label for="httpUrl">URL:</label>
                        <input type="url" id="httpUrl" placeholder="http://localhost:8080/mcp">
                    </div>
                    <div class="form-group">
                        <label for="httpApiKey">API Key (optional):</label>
                        <input type="text" id="httpApiKey" placeholder="your-api-key">
                    </div>
                </div>

                <div id="sse-config" class="server-config-section" style="display: none;">
                    <h3>Server-Sent Events Configuration</h3>
                    <div class="form-group">
                        <label for="sseUrl">SSE Endpoint URL:</label>
                        <input type="url" id="sseUrl" placeholder="http://localhost:8080/sse">
                    </div>
                    <div class="form-group">
                        <label for="sseApiKey">API Key (optional):</label>
                        <input type="text" id="sseApiKey" placeholder="your-api-key">
                    </div>
                </div>

                <div class="form-group">
                    <button class="control-btn btn-start" onclick="addMcpServer()">Add Server</button>
                    <button class="control-btn btn-stop" onclick="closeMcpServerForm()">Cancel</button>
                </div>
            </div>
        </div>

        <!-- MCP Servers List Modal -->
        <div id="mcpServersModal" class="modal" style="display: none;">
            <div class="modal-content">
                <span class="close" onclick="closeMcpServersList()">&times;</span>
                <h2>Current MCP Servers</h2>
                <div id="mcpServersList"></div>
            </div>
        </div>

        <!-- MCP Config Modal -->
        <div id="mcpConfigModal" class="modal" style="display: none;">
            <div class="modal-content">
                <span class="close" onclick="closeMcpConfig()">&times;</span>
                <h2>MCPO Configuration</h2>
                <pre id="mcpConfigContent"></pre>
            </div>
        </div>

        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>Loading service status...</p>
        </div>

        <div id="dashboard" style="display: none;">
            <div class="overview">
                <div class="overview-card">
                    <div class="number" id="total-services">-</div>
                    <div class="label">Total Services</div>
                </div>
                <div class="overview-card">
                    <div class="number" id="healthy-services" style="color: #10b981;">-</div>
                    <div class="label">Healthy Services</div>
                </div>
                <div class="overview-card">
                    <div class="number" id="unhealthy-services" style="color: #ef4444;">-</div>
                    <div class="label">Unhealthy Services</div>
                </div>
                <div class="overview-card">
                    <div class="number" id="system-status">-</div>
                    <div class="label">System Status</div>
                </div>
            </div>

            <div id="categories"></div>

            <div class="last-updated">
                Last updated: <span id="last-updated">-</span>
            </div>
        </div>

        <div id="error" class="error" style="display: none;">
            Failed to load service status. Please check your connection.
        </div>
    </div>

    <script>
        let statusData = null;

        async function loadStatus() {
            try {
                const response = await fetch('/api/status/cached');
                if (!response.ok) {
                    throw new Error('Failed to fetch status');
                }

                statusData = await response.json();
                renderDashboard();

                document.getElementById('loading').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';
                document.getElementById('error').style.display = 'none';

            } catch (error) {
                console.error('Error loading status:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
            }
        }

        function renderDashboard() {
            if (!statusData) return;

            const { overall, categories } = statusData;

            // Update overview with MCP servers breakdown
            document.getElementById('total-services').textContent = overall.total;
            document.getElementById('healthy-services').textContent = overall.healthy;
            document.getElementById('unhealthy-services').textContent = overall.unhealthy;
            document.getElementById('system-status').textContent = overall.status.toUpperCase();

            // Update breakdown info if MCP servers are present
            const totalLabel = document.querySelector('#total-services').nextElementSibling;
            if (overall.mcpServers > 0) {
                totalLabel.innerHTML = `Services <small>(${overall.regularServices} regular + ${overall.mcpServers} MCP)</small>`;
            } else {
                totalLabel.textContent = 'Services';
            }
            document.getElementById('last-updated').textContent = new Date(overall.lastUpdated).toLocaleString();

            // Set system status color
            const statusElement = document.getElementById('system-status');
            const statusColors = {
                healthy: '#10b981',
                degraded: '#f59e0b',
                unhealthy: '#ef4444'
            };
            statusElement.style.color = statusColors[overall.status] || '#6b7280';

            // Render categories
            const categoriesContainer = document.getElementById('categories');
            categoriesContainer.innerHTML = '';

            Object.entries(categories).forEach(([categoryName, services]) => {
                const categoryElement = createCategoryElement(categoryName, services);
                categoriesContainer.appendChild(categoryElement);
            });
        }

        function createCategoryElement(categoryName, services) {
            const category = document.createElement('div');
            category.className = 'category';

            const header = document.createElement('div');
            header.className = 'category-header';
            header.textContent = categoryName;

            const servicesGrid = document.createElement('div');
            servicesGrid.className = 'services-grid';

            services.forEach(service => {
                const serviceCard = createServiceCard(service);
                servicesGrid.appendChild(serviceCard);
            });

            category.appendChild(header);
            category.appendChild(servicesGrid);
            return category;
        }

        function createServiceCard(service) {
            const card = document.createElement('div');
            card.className = 'service-card';

            const statusClass = `status-${service.status}`;
            const badgeClass = `badge-${service.status}`;

            // Special styling for MCP servers
            const isMcpServer = service.type === 'mcp-server';
            const mcpIcon = isMcpServer ? '🔌 ' : '';
            const mcpClass = isMcpServer ? ' mcp-server' : '';

            card.innerHTML = `
                <div class="service-header">
                    <div class="service-name">
                        <span class="status-indicator ${statusClass}"></span>
                        ${mcpIcon}${service.name}
                    </div>
                    <div class="status-badge ${badgeClass}">
                        ${service.status}
                    </div>
                </div>
                <div class="service-description">
                    ${service.description}
                </div>
                <div class="service-metrics">
                    ${service.statusCode ? `<div class="metric">📊 ${service.statusCode}</div>` : ''}
                    ${service.responseTime ? `<div class="metric">⚡ ${service.responseTime}ms</div>` : ''}
                    ${service.url ? `<div class="metric">🔗 ${service.url}</div>` : '<div class="metric">📝 STDIO Server</div>'}
                </div>
                ${service.externalUrl ? `<a href="${service.externalUrl}" target="_blank" class="external-link">🌐 Open Service</a>` : ''}
                ${service.error && service.error !== 'STDIO server - health assumed' ? `<div style="color: #dc2626; font-size: 0.8rem; margin-top: 0.5rem;">❌ ${service.error}</div>` : ''}
                <div class="service-controls${mcpClass}">
                    ${isMcpServer ? `
                        <button class="btn-warning" onclick="removeMcpServerFromCard('${service.name}')">Remove MCP Server</button>
                    ` : `
                        <button class="btn-success" onclick="startService('${service.name.toLowerCase().replace(/\s+/g, '-')}')">Start</button>
                        <button class="btn-warning" onclick="restartService('${service.name.toLowerCase().replace(/\s+/g, '-')}')">Restart</button>
                        <button class="btn-stop" onclick="stopService('${service.name.toLowerCase().replace(/\s+/g, '-')}')">Stop</button>
                    `}
                </div>
            `;

            if (isMcpServer) {
                card.style.border = '2px solid #8b5cf6';
                card.style.background = 'linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(168, 85, 247, 0.05))';
            }

            return card;
        }

        // Auto-refresh every 30 seconds
        function startAutoRefresh() {
            loadStatus();
            setInterval(loadStatus, 30000);
        }

        // Service Management Functions
        async function performBulkAction(action) {
            const operationStatus = document.getElementById('operationStatus');
            const buttons = document.querySelectorAll('.control-btn');

            // Disable buttons during operation
            buttons.forEach(btn => {
                btn.classList.add('btn-disabled');
                btn.disabled = true;
            });

            operationStatus.style.display = 'block';
            operationStatus.className = 'operation-status';
            operationStatus.innerHTML = `<strong>Operation in progress...</strong><br>Executing ${action} on all services. This may take a few minutes.`;

            try {
                const response = await fetch(`/api/services/${action}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();

                if (result.success) {
                    operationStatus.className = 'operation-status operation-success';
                    operationStatus.innerHTML = `<strong>✅ Success!</strong><br>${result.message}`;

                    // Refresh status after a brief delay
                    setTimeout(() => {
                        loadStatus();
                    }, 3000);
                } else {
                    operationStatus.className = 'operation-status operation-error';
                    operationStatus.innerHTML = `<strong>❌ Error:</strong><br>${result.message}`;
                }
            } catch (error) {
                operationStatus.className = 'operation-status operation-error';
                operationStatus.innerHTML = `<strong>❌ Error:</strong><br>Failed to ${action} services: ${error.message}`;
            } finally {
                // Re-enable buttons
                setTimeout(() => {
                    buttons.forEach(btn => {
                        btn.classList.remove('btn-disabled');
                        btn.disabled = false;
                    });
                }, 2000);
            }
        }

        async function performServiceAction(serviceName, action) {
            const button = event.target;
            const originalText = button.innerHTML;

            button.disabled = true;
            button.innerHTML = '⏳ Working...';

            try {
                const response = await fetch(`/api/service/${serviceName}/${action}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();

                if (result.success) {
                    button.innerHTML = '✅ Done';
                    setTimeout(() => {
                        button.innerHTML = originalText;
                        button.disabled = false;
                        loadStatus(); // Refresh status
                    }, 2000);
                } else {
                    button.innerHTML = '❌ Failed';
                    setTimeout(() => {
                        button.innerHTML = originalText;
                        button.disabled = false;
                    }, 3000);
                    console.error(`Failed to ${action} ${serviceName}:`, result.message);
                }
            } catch (error) {
                button.innerHTML = '❌ Error';
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.disabled = false;
                }, 3000);
                console.error(`Error performing ${action} on ${serviceName}:`, error);
            }
        }

        // MCP Server Management Functions
        let mcpTemplates = {};

        async function loadMcpTemplates() {
            try {
                const response = await fetch('/api/mcpo/templates');
                mcpTemplates = await response.json();
            } catch (error) {
                console.error('Failed to load MCP templates:', error);
            }
        }

        function showMcpServerForm() {
            document.getElementById('mcpServerModal').style.display = 'block';
        }

        function closeMcpServerForm() {
            document.getElementById('mcpServerModal').style.display = 'none';
            // Reset form
            document.getElementById('serverTemplate').value = '';
            document.getElementById('serverName').value = '';
            document.getElementById('serverDescription').value = '';
            hideAllConfigSections();
        }

        function hideAllConfigSections() {
            document.querySelectorAll('.server-config-section').forEach(section => {
                section.style.display = 'none';
            });
        }

        function loadServerTemplate() {
            const templateType = document.getElementById('serverTemplate').value;
            hideAllConfigSections();

            if (templateType && mcpTemplates[templateType]) {
                const template = mcpTemplates[templateType];
                const configSection = document.getElementById(`${templateType}-config`);
                if (configSection) {
                    configSection.style.display = 'block';

                    // Pre-populate form fields based on template
                    if (templateType === 'stdio' && template.config) {
                        document.getElementById('stdioCommand').value = template.config.command || '';
                        document.getElementById('stdioArgs').value = template.config.args ? template.config.args.join('\\n') : '';
                    }
                }
            }
        }

        async function addMcpServer() {
            const serverName = document.getElementById('serverName').value.trim();
            const serverDescription = document.getElementById('serverDescription').value.trim();
            const templateType = document.getElementById('serverTemplate').value;

            if (!serverName || !templateType) {
                alert('Server name and type are required');
                return;
            }

            // Build server configuration based on template type
            let serverConfig = {
                description: serverDescription || `${templateType} MCP server`
            };

            try {
                switch (templateType) {
                    case 'stdio':
                        const command = document.getElementById('stdioCommand').value.trim();
                        const argsText = document.getElementById('stdioArgs').value.trim();
                        const args = argsText ? argsText.split('\\n').filter(arg => arg.trim()) : [];

                        if (!command) {
                            alert('Command is required for stdio servers');
                            return;
                        }

                        serverConfig.command = command;
                        serverConfig.args = args;
                        break;

                    case 'http':
                        const httpUrl = document.getElementById('httpUrl').value.trim();
                        const httpApiKey = document.getElementById('httpApiKey').value.trim();

                        if (!httpUrl) {
                            alert('URL is required for HTTP servers');
                            return;
                        }

                        serverConfig.type = 'streamable-http';
                        serverConfig.url = httpUrl;

                        if (httpApiKey) {
                            serverConfig.headers = {
                                'Authorization': `Bearer ${httpApiKey}`,
                                'Content-Type': 'application/json'
                            };
                        }
                        break;

                    case 'sse':
                        const sseUrl = document.getElementById('sseUrl').value.trim();
                        const sseApiKey = document.getElementById('sseApiKey').value.trim();

                        if (!sseUrl) {
                            alert('SSE URL is required for SSE servers');
                            return;
                        }

                        serverConfig.type = 'sse';
                        serverConfig.url = sseUrl;

                        if (sseApiKey) {
                            serverConfig.headers = {
                                'Authorization': `Bearer ${sseApiKey}`
                            };
                        }
                        break;
                }

                // Send request to add server
                const response = await fetch('/api/mcpo/servers', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        serverName: serverName,
                        serverConfig: serverConfig
                    })
                });

                const result = await response.json();

                if (result.success) {
                    const mcpStatus = document.getElementById('mcpOperationStatus');
                    mcpStatus.style.display = 'block';
                    mcpStatus.className = 'operation-status operation-success';
                    mcpStatus.innerHTML = `<strong>✅ Success!</strong><br>MCP server "${serverName}" added successfully. Hot reload will apply changes automatically.`;

                    closeMcpServerForm();

                    // Hide status message after 5 seconds
                    setTimeout(() => {
                        mcpStatus.style.display = 'none';
                    }, 5000);
                } else {
                    alert(`Error: ${result.error || result.message}`);
                }

            } catch (error) {
                console.error('Failed to add MCP server:', error);
                alert(`Failed to add MCP server: ${error.message}`);
            }
        }

        async function loadMcpServers() {
            try {
                const response = await fetch('/api/mcpo/servers');
                const data = await response.json();

                const serversListDiv = document.getElementById('mcpServersList');
                serversListDiv.innerHTML = '';

                if (data.success && data.servers && data.servers.length > 0) {
                    data.servers.forEach(server => {
                        const serverDiv = document.createElement('div');
                        serverDiv.className = 'server-item';

                        const statusIcon = server.status === 'healthy' ? '✅' : '❌';
                        const statusClass = server.status === 'healthy' ? 'text-green-600' : 'text-red-600';
                        const serverType = server.url ? 'HTTP/SSE' : 'STDIO';

                        serverDiv.innerHTML = `
                            <div class="server-info">
                                <h4>${statusIcon} ${server.name} <span style="font-size: 0.8em; color: #666;">(${serverType})</span></h4>
                                <p>${server.description || 'No description'}</p>
                                <div style="font-size: 0.9em; margin-top: 0.5rem;">
                                    <span class="${statusClass}" style="font-weight: bold;">Status: ${server.status}</span>
                                    ${server.responseTime ? ` | Response: ${server.responseTime}ms` : ''}
                                    ${server.statusCode && server.statusCode !== 'N/A' ? ` | Code: ${server.statusCode}` : ''}
                                </div>
                                ${server.url ? `<div style="font-size: 0.8em; color: #666; margin-top: 0.25rem;">URL: ${server.url}</div>` : ''}
                                ${server.error && server.error !== 'STDIO server - health assumed' ? `<div style="color: #dc2626; font-size: 0.8em; margin-top: 0.25rem;">Error: ${server.error}</div>` : ''}
                            </div>
                            <div class="server-actions">
                                <button class="btn-stop" onclick="removeMcpServer('${server.name}')">Remove</button>
                            </div>
                        `;
                        serversListDiv.appendChild(serverDiv);
                    });

                    // Add summary
                    const summaryDiv = document.createElement('div');
                    summaryDiv.style.cssText = 'margin-top: 1rem; padding: 1rem; background: #f3f4f6; border-radius: 8px; font-size: 0.9em;';
                    const healthyCount = data.servers.filter(s => s.status === 'healthy').length;
                    summaryDiv.innerHTML = `<strong>Summary:</strong> ${data.servers.length} MCP servers configured (${healthyCount} healthy, ${data.servers.length - healthyCount} unhealthy)`;
                    serversListDiv.appendChild(summaryDiv);
                } else {
                    serversListDiv.innerHTML = '<p>No MCP servers configured.</p>';
                }

                document.getElementById('mcpServersModal').style.display = 'block';

            } catch (error) {
                console.error('Failed to load MCP servers:', error);
                alert(`Failed to load MCP servers: ${error.message}`);
            }
        }

        function closeMcpServersList() {
            document.getElementById('mcpServersModal').style.display = 'none';
        }

        async function removeMcpServer(serverName) {
            if (!confirm(`Are you sure you want to remove the MCP server "${serverName}"?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/mcpo/servers/${serverName}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    const mcpStatus = document.getElementById('mcpOperationStatus');
                    mcpStatus.style.display = 'block';
                    mcpStatus.className = 'operation-status operation-success';
                    mcpStatus.innerHTML = `<strong>✅ Success!</strong><br>MCP server "${serverName}" removed successfully.`;

                    // Reload the servers list
                    loadMcpServers();

                    // Hide status message after 5 seconds
                    setTimeout(() => {
                        mcpStatus.style.display = 'none';
                    }, 5000);
                } else {
                    alert(`Error: ${result.error || result.message}`);
                }

            } catch (error) {
                console.error('Failed to remove MCP server:', error);
                alert(`Failed to remove MCP server: ${error.message}`);
            }
        }

        async function showMcpConfig() {
            try {
                const response = await fetch('/api/mcpo/config');
                const config = await response.json();

                document.getElementById('mcpConfigContent').textContent = JSON.stringify(config, null, 2);
                document.getElementById('mcpConfigModal').style.display = 'block';

            } catch (error) {
                console.error('Failed to load MCP config:', error);
                alert(`Failed to load MCP config: ${error.message}`);
            }
        }

        function closeMcpConfig() {
            document.getElementById('mcpConfigModal').style.display = 'none';
        }

        // Remove MCP server from service card
        async function removeMcpServerFromCard(serverName) {
            if (!confirm(`Are you sure you want to remove the MCP server "${serverName}"?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/mcpo/servers/${serverName}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    // Refresh the entire dashboard to show updated counts
                    await loadStatus();

                    // Show success message briefly
                    const successMessage = document.createElement('div');
                    successMessage.style.cssText = `
                        position: fixed; top: 20px; right: 20px; z-index: 1000;
                        background: #10b981; color: white; padding: 1rem 2rem;
                        border-radius: 8px; font-weight: bold;
                    `;
                    successMessage.innerHTML = `✅ MCP server "${serverName}" removed successfully`;
                    document.body.appendChild(successMessage);

                    setTimeout(() => {
                        document.body.removeChild(successMessage);
                    }, 3000);
                } else {
                    alert(`Error: ${result.error || result.message}`);
                }

            } catch (error) {
                console.error('Failed to remove MCP server:', error);
                alert(`Failed to remove MCP server: ${error.message}`);
            }
        }

        // Close modals when clicking outside
        window.onclick = function (event) {
            const modals = ['mcpServerModal', 'mcpServersModal', 'mcpConfigModal'];
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }

        // Initialize
        loadMcpTemplates();
        startAutoRefresh();

        // Manual refresh on focus
        window.addEventListener('focus', loadStatus);
    </script>
</body>

</html>